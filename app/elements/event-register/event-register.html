<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<dom-module id="event-register">
  <template>
    <style>
      div#errormessage {
        color: red;
      }
    </style>
    <paper-progress
      id="progress"
      max="4"
      secondary-progress="1"
      style="width: 400px;"
      value="0"></paper-progress>
    <p>In order to register, I need to ask you 4 questions:</p>
    <form id="form" is="iron-form" style="width: 400px;">
      <paper-input
        autocomplete="name"
        autofocus="true"
        error-message="Please tell us your name!"
        id="name"
        label="First, what should I call you?"
        name="name"
        on-change="_onChangeName"
        required
        type="text"></paper-input>
      <gold-email-input
        autocomplete="email"
        error-message="Please enter a valid email address."
        id="email"
        label="Next, I need your email address."
        name="email"
        on-change="_onChangeEmail"
        regex="^\w+@\w+(\.\w+)+$"
        style="visibility: hidden;"
        type="email"
        required></gold-email-input>
      <paper-input
        id="password"
        label="Awesome, now Choose a password."
        on-change="_onChangePassword"
        style="visibility: hidden;"
        type="password"
        required></paper-input>
      <ul id="please" style="visibility: hidden;">
        <li id="error-len">It must be at least 8 characters long.</li>
        <li id="error-letter">It must contain at least one letter,</li>
        <li id="error-digit">one digit,</li>
        <li id="error-special">and one special character (!@#$%^& or *).</li>
      </ul>
      <paper-input
        error-message="Passwords must match."
        id="verify"
        label="And finally, verify your password!"
        on-change="_onChangeVerify"
        style="visibility: hidden;"
        type="password"
        required></paper-input>
      <div id="buttons" style="visibility: hidden;">
        <p>
        Fantastic, thats all the required information.
        </p>
        <div id="errormessage">[[errorMessage]]</div>
        <paper-button raised on-click="onSubmit" id="register">Continue</paper-button>
      </div>
    </form>
  </template>
  <script>
    Polymer({
      is: 'event-register',

      properties: {
        callback: Function
      },

      // ready: function() {
      //   this.$.email.style.visibility = "visible";
      //   this.$.password.style.visibility = "visible";
      //   this.$.please.style.visibility = "visible";
      //   this.$.verify.style.visibility = "visible";
      //   this.$.buttons.style.visibility = "visible";
      //   this.errorMessage = "Error Message"
      // },

      _valid: {
        name: false,
        email: false,
        password: false,
        verify: false
      },
      updateProgressBar: function() {
        var count = 0;
        for (var key in this._valid) {
          if (this._valid[key] === true)
            count += 1;
        }

        this.$.progress.value = count;
        this.$.progress.secondaryProgress = count + 1;
      },

      _onChangeName: function() {
        this._valid.name = this.$.name.validate();
        if (this._valid.name) {
          this.$.email.style.visibility = "visible";
          this.$.email.focus();
        }
        this.updateProgressBar();
      },
      _onChangeEmail: function() {
        this._valid.email = this.$.email.validate();
        if (this._valid.email) {
          this.$.password.style.visibility = "visible";
          this.$.please.style.visibility = "visible";
          this.$.password.focus();
        }
        this.updateProgressBar();
      },
      _onChangePassword: function() {
        var password = this.$.password.value;
        this._valid.password = true;

          if (password.length < 8) {
            this.$['error-len'].style.color = 'red';
            this._valid.password = false;
          } else {
            this.$['error-len'].style.color = 'green';
          }

          if (!/[a-zA-Z]/g.test(password)) {
            this.$['error-letter'].style.color = 'red';
            this._valid.password = false;
          } else {
            this.$['error-letter'].style.color = 'green';
          }

          if (!/\d/g.test(password)) {
            this.$['error-digit'].style.color = 'red';
            this._valid.password = false;
          } else {
            this.$['error-digit'].style.color = 'green';
          }

          if (!/[\!\@\#\$\%\^\&\*]/g.test(password)) {
            this.$['error-special'].style.color = 'red';
            this._valid.password = false;
          } else {
            this.$['error-special'].style.color = 'green';
          }

          this.$.password.invalid = !this._valid.password;
          if (this._valid.password) {
            this.$.verify.style.visibility = "visible";
            this.$.verify.focus();
          }
          this.updateProgressBar();
      },
      _onChangeVerify: function() {
//          valid.verify = verifyElement.validate();
          if (this.$.password.value && this.$.verify.value &&
              this.$.password.value == this.$.verify.value) {
            this.$.verify.invalid = false;
            this._valid.verify = true;
            this.$.buttons.style.visibility = "visible";
            this.$.register.focus();
          } else {
            this.$.verify.invalid = true;
            this._valid.verify = false;
          }
          this.updateProgressBar();
      },
      onSubmit: function() {
        console.log('on submit');
        var that = this;
        this.$.errormessage.innerHtml = "Processing...";
        this.callback({
          name: this.$.name.value,
          email: this.$.email.value,
          password: this.$.password.value
        }).then(function() {
          that.$.name.value = "";
          that.$.email.value = "";
          that.$.password.value = "";
          that.$.verify.value = "";
        }).catch(function(error) {
          console.log('callback', error);
          that.errorMessage = error.message;
        });
        // this.fire('kick', {
        //   name: this.$.name.value,
        //   email: this.$.email.value,
        //   password: this.$.password.value,
        //   callback: function(error) {
        //     console.log('callback', error);
        //     that.errorMessage = error.message;
        //   }
        // });
      }
    });
  </script>
</dom-module>

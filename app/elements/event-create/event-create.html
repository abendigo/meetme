<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="input-guest-list.html">
<link rel="import" href="input-location.html">

<dom-module id="event-create">
  <template>
    <style>
      paper-button {
        background-color: antiquewhite;
      }

      div#errormessage {
        height: 20px;
        color: red;
      }
    </style>
    <form id="createEvent" is="iron-form" style="width: 400px; margin: auto;">
      <paper-input
        autofocus
        error-message="The event needs a name!"
        id="name"
        label="Name of the event (required)"
        name="name"
        on-blur="_onBlurName"
        required></paper-input>
      <paper-input-container>
        <label for="type">Type of the event</label>
        <input
          is="iron-input"
          list="list"
          name="type"></input>
        <datalist id="list">
          <option value='Birthday Party'></option>
          <option value='Conference Talk'></option>
          <option value='Wedding'></option>
        </datalist>
      </paper-input-container>
      <paper-input
        error-message="Every event needs a host."
        id="host"
        label="Host (indivdual or organization) (required)"
        name="host"
        on-blur="_onBlurHost"
        required
        value="[[profile.name]]"></paper-input>
      <paper-input-container id="startcontainer" always-float-label>
        <label for="start">Start Date and Time (required)</label>
        <input
          id="start"
          is="iron-input"
          name="start"
          on-blur="_validateStart"
          required
          type="datetime-local"></input>
        <paper-input-error>[[startTimeError]]</paper-input-error>
      </paper-input-container>
      <paper-input-container id="endcontainer" always-float-label>
        <label for="end">End Date and Time</label>
        <input
          id="end"
          is="iron-input"
          name="end"
          on-blur="_validateEnd"
          type="datetime-local"></input>
        <paper-input-error>[[endTimeError]]</paper-input-error>
      </paper-input-container>
      <input-location
        label="Location"
        name="location"></input-location>
      <input-guest-list name="guests" required></input-guest-list>
      <paper-textarea
        label="Message"
        name="message"></paper-textarea>
      <div id="errormessage">[[errorMessage]]</div>
      <paper-button on-click="onSubmit" raised>Create Event</paper-button>
    </form>
  </template>
  <script>
    Polymer({
      is: 'event-create',

      listeners: {
        'createEvent.iron-form-presubmit': '_presubmit'
      },

      properties: {
        callback: Function,
        profile: Object,
        startTimeErorr: String,
        endTimeError: String,
        errorMessage: String
      },

      _onBlurName: function(event) {
        this.$.name.validate();
      },
      _onBlurHost: function(event) {
        this.$.host.validate();
      },
      _validateStart: function(event) {
        this.$.startcontainer.invalid = false;

        var whenString = this.$.start.value;
        if (whenString) {
          var whenDate = new Date(whenString);

          if (whenDate.getTime() < Date.now()) {
            this.startTimeError = 'Event must start in the future.';
            this.$.startcontainer.invalid = true;
          }
        } else {
          this.startTimeError = 'When does the event start?';
          this.$.startcontainer.invalid = true;
        }
      },
      _validateEnd: function(event) {
        this.$.endcontainer.invalid = false;

        var startString = this.$.start.value;
        var endString = this.$.end.value;
        if (endString) {
          var startDate = new Date(startString);
          var endDate = new Date(endString);

          if (startDate.getTime() >= endDate.getTime()) {
            this.endTimeError = 'Event cant finish before it starts.';
            this.$.endcontainer.invalid = true;
          }
        }
      },

      onSubmit: function() {
        this._validateStart();
        this._validateEnd();

        if (!this.$.startcontainer.invalid && !this.$.endcontainer.invalid) {
          this.$.createEvent.submit();
        }
      },
      _presubmit: function(event) {
        event.preventDefault();

        this.errorMessage = "Processing...";

        var data = this.$.createEvent.serialize();
        Object.keys(data).forEach(function(next) {
          if (!data[next]) {
            delete data[next];
          }
        });

        var that = this;
        this.callback(data)
        .then(function() {
          that.$.errorMessage = '';

          that.$.name.value = '';
          that.$.host.value = that.profile.name;
          that.$.start.value = '';
          that.$.end.value = '';
        }, function(error) {
          that.$.errorMessage = error;
        });
      }
    });
  </script>
</dom-module>

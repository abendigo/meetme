<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MeetMe, Event Planning</title>

    <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="bower_components/page/page.js"></script>

    <link rel="import" href="bower_components/firebase-element/firebase-auth.html">

    <link rel="import" href="elements/event-create/event-create.html">
    <link rel="import" href="elements/event-data/event-data.html">
    <link rel="import" href="elements/event-list/event-list.html">
    <link rel="import" href="elements/event-register/event-register.html">
    <link rel="import" href="elements/profile-data/profile-data.html">

    <link rel="import" href="bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
    <link rel="import" href="bower_components/app-layout/app-header-layout/app-header-layout.html">
    <link rel="import" href="bower_components/app-layout/app-header/app-header.html">
    <link rel="import" href="bower_components/app-layout/app-toolbar/app-toolbar.html">

    <link rel="import" href="bower_components/iron-pages/iron-pages.html">
    <link rel="import" href="bower_components/iron-icons/editor-icons.html">
    <link rel="import" href="bower_components/iron-icons/iron-icons.html">
    <link rel="import" href="bower_components/iron-icon/iron-icon.html">

    <link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">

    <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="bower_components/paper-card/paper-card.html">
    <link rel="import" href="bower_components/paper-menu/paper-menu.html">
    <link rel="import" href="bower_components/paper-item/paper-item.html">

    <style is="custom-style">
  paper-menu iron-icon {
    margin-right: 33px;
    opacity: 0.54;
  }

  .paper-menu > .iron-selected {
    color: var(--default-primary-color);
  }

  paper-menu a {
    @apply(--layout-horizontal);
    @apply(--layout-center);
    text-decoration: none;
    color: var(--menu-link-color);
    font-family: 'Roboto', 'Noto', sans-serif;
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
    font-size: 14px;
    font-weight: 400;
    line-height: 24px;
    min-height: 48px;
    padding: 0 16px;
  }
    </style>
  </head>
  <body>
    <template is="dom-bind" id="my-template">
      <firebase-auth id="firebaseLogin"
        user="{{user}}"
        status-known="{{statusKnown}}"
        location="https://m13d-meetme.firebaseio.com"
        provider="password">
      </firebase-auth>
      <profile-data id="profileData"
        location="https://m13d-meetme.firebaseio.com"
        profile="{{profile}}"
        user="[[user]]"></profile-data>
      <event-data events="{{events}}"></event-data>
      <app-drawer-layout id="myLayout" drawer-width="288px" responsive-width="900px">
        <div id="menuDrawer" drawer>
          <paper-menu attr-for-selected="data-route" selected="[[route]]">
            <a data-route="welcome" href="/welcome">
              <iron-icon icon="home"></iron-icon>
              <span>Welcome</span>
            </a>
            <a data-route="login" href="/login" hidden$="[[user.uid]]">
              <iron-icon icon="face"></iron-icon>
              <span>Login</span>
            </a>
            <a data-route="register" href="/register" hidden$="[[user.uid]]">
              <iron-icon icon="create"></iron-icon>
              <span>Register</span>
            </a>
            <a data-route="profile" href="/profile" hidden$="[[!user.uid]]">
              <iron-icon icon="create"></iron-icon>
              <span>Profile</span>
            </a>
            <a data-route="create" href="/create" hidden$="[[!user.uid]]">
              <iron-icon icon="add"></iron-icon>
              <span>Create Event</span>
            </a>
            <a data-route="list" href="/list">
              <iron-icon icon="list"></iron-icon>
              <span>List Events</span>
            </a>
            <a hidden$="[[!user.uid]]" href="#" on-tap="logout">
              <iron-icon icon="close"></iron-icon>
              <span>Logout</span>
            </a>
          </paper-menu>
        </div>
        <app-header-layout main>
          <app-header>
            <h1>Meet Me</h1>
            <!--app-toolbar-->
              <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
            <!--/app-toolbar-->
          </app-header>
            <iron-pages id="pages" attr-for-selected="data-route" selected="[[route]]">
              <div data-route="welcome">
                <div hidden$="[[user.uid]]">
                  <span>Non logged in users see this</span>
                </div>
                <div hidden$="[[!user.uid]]">
                  <span>Logged in users see this!</span>
                </div>
              </div>
              <div data-route="login">
                <button on-tap="login">login</button>
              </div>
              <div data-route="profile" style="max-width: 400px;">
                <form is="iron-form">
                  <paper-input label="Name" value="[[profile.name]]"></paper-input>
                  <paper-input label="Email Address" value="[[user.password.email]]"></paper-input>
                  <paper-input label="Organization" value="[[profile.organization]]"></paper-input>
                  <paper-button raised>Undo Changes</paper-button>
                  <paper-button raised>Save Changes</paper-button>
                </form>
              </div>
              <event-register data-route="register" callback="[[registerCallback]]"></event-register>
              <event-create data-route="create" profile="[[profile]]" on-add-event="onAddEvent" style="max-width: 400px;"></event-create>
              <event-list data-route="list" events=[[events]]></event-list>
            </iron-pages>
        </app-header-layout>
      </app-drawer-layout>
    </template>
    <script>
      document.addEventListener('WebComponentsReady', function() {
        var template = document.getElementById('my-template');
        var fbLogin = template.$.firebaseLogin; // document.getElementById('firebaseLogin');
        var profileData = template.$.profileData;

        template.params = {email: 'user@example.com', password: 'abcd123$'};

        console.log(template.$.firebaseLogin);
        console.log(fbLogin)

//        template.user = "marko";
        template.login = function() {

          function loginSuccess(event) {
            console.log('on login', event.detail);
            template.route = 'welcome';

            fbLogin.removeEventListener('login', loginSuccess);
          }
          fbLogin.addEventListener('login', loginSuccess);

          fbLogin.login({email: 'user@example.com', password: 'abcd123$'});
        };
        template.logout = function() {
          console.log('logout', this);
          fbLogin.logout();
          template.route = 'list';
        };
        template.onError = function(e) {
          console.log('onError', e);
        };
        template.onSuccess = function(e) {
          console.log('onSuccess', e);
        };

        template.registerCallback = function(data, callback) {
          console.log('register callback');

          function userCreated(event) {
            console.log('user created', event.detail);

            function loginSuccess(event) {
              console.log('loginSuccess', event.detail);

              template.profile = {name: data.name};
              fbLogin.removeEventListener('login', loginSuccess);

              callback();
            }

            fbLogin.addEventListener('login', loginSuccess);

            fbLogin.login({email: data.email, password: data.password});

//            fbLogin.removeEventListener('user-created', userCreated);
          }

          function createUserError(event) {
            console.log('create user error', event.details, arguments);
            callback(event.details);
          }

          fbLogin.addEventListener('user-created', userCreated);
          fbLogin.addEventListener('error', createUserError);

          // template.onError = function(event, error) {
          //   console.log('create user error', error);
          //   callback(error);
          // }
          fbLogin.createUser(data.email, data.password);
        }

        template.onAddEvent = function(e, data) {
          console.log('onAddEvent', data);
          this.push('events', data.form);
          data.callback();
        }

        console.log('ready', template.statusKnown);

        // Loop over the children of iron-pages, and build a list of routes!
        var routes = template.$.pages.items.map(function(next) {
          return next.dataset.route;
        });

        page.base('/');
        page('*', function(context, next) {
          var path = context.path;
          if (routes.indexOf(path) === -1) {
            page.show('/welcome');
          } else {
            template.$.myLayout.opened = false;
            template.route = path;
          }
        });
        page({
          click: true,
          hashbang: true});
      });
    </script>
  </body>
</html>